<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="steps.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<title>Replayer</title>
</head>
<body>
	<div id="screen" style="background-color: black; color: white; min-height: 80vh;"></div>
	<div id="buttons" style="text-align: center;">
		<span id="current-step">(Kein Replay</span><span id="nb-steps"> geladen)</span>
		<button onclick="pre();">&#x25c0;</button>
		<button onclick="playPause(this);">&#x23ef;</button>
		<button onclick="nxt();">&#x25b6;</button>
	</div>
	<div>
		<h2>Replay anschauen</h2>
		<label for="file-to-load">Replay-Datei (JSON) hier ausw&auml;hlen:</label>
		<input type="file" id="file-to-load"/>
		<br/>
		<label for="load-file-button">Dann hier zum Laden clicken:</label>
		<button onclick="loadFile();" id="load-file-button">Datei laden</button>
	</div>
	<div>
		<h2>Mit Live-Server verbinden</h2>
		<label for="server-to-connect">Server-Adresse</label>
		<input type="text" id="server-to-connect" value="localhost:8000"/>
		<button onclick="connectToServer();">Mit Server verbinden</button>
		<span>Status:</span><span id="connection-status">Nicht verbunden</span>
	</div>
</body>
<script>
	var steps = [];
	var inverts = [];
	var playing = false;
	var initialized = false;
	var playLock = undefined;
	var socket = undefined;
	var currentStep = 0;

	var stepCountDom = document.getElementById('step-count');
	var connectionStatusDom = document.getElementById('connection-status');

	const nxt = () => {
		const step = steps.shift();
		if(!step) return false;
		currentStep++; document.getElementById('current-step').textContent = currentStep;
		bwstep = apply(step, false);
		inverts.unshift( bwstep );
		return true;
	}
	const pre = () => {
		const inver = inverts.shift();
		if(!inver) return false;
		currentStep--; document.getElementById('current-step').textContent = currentStep;
		step = apply(inver, true);
		steps.unshift( step );
		return true;
	}
	const playLoop = (playBtn) => { const ret = nxt(); if(!ret){ pause(playBtn); } }
	const play = (playBtn) => {
		if(nxt()){
			playing = true;
			playBtn.textContent = '\u23f8';
			playLock = setInterval(playLoop, 1200, playBtn);
		}
	}
	const pause = (playBtn) => {
		playing = false;
		playBtn.textContent = '\u23ef';
		clearInterval(playLock);
		playLock = undefined;
	}
	const playPause = (playBtn) => {
		if(!playing) play(playBtn);
		else pause(playBtn);
	}
	const reloadNbSteps = () => {
		document.getElementById('nb-steps').textContent = '/' + (steps.length + currentStep); 
	}
	const reloadCurrentStep = () => { document.getElementById('current-step').textContent = currentStep; }
	const restart = (stepsNState) => {
		state = stepsNState.state;
		steps = stepsNState.steps;
		inverts = [];
		currentStep = 0;
		reloadNbSteps(); reloadCurrentStep();
	}
	const loadFile = () => {
		const fileInput = document.getElementById('file-to-load');
		let file = fileInput.files[0];
		console.log(file);
		let reader = new FileReader();
		reader.onload = () => {
			stepsNState = readGame(reader.result);
			restart(stepsNState);
		}
		reader.onerror = () => { console.warn('Could not load file because...\n' + reader.error); }
		reader.readAsText(file);
	}
	const connectToServer = () => {
		const url = document.getElementById('server-to-connect').value;
		connectionStatusDom.textContent = 'Verbindung starten...';
		if(window.WebSocket === undefined) {
			connectionStatusDom.textContent = 'WebSockets nicht unterstÃ¼tzt!';
			return;
		}

		socket = new WebSocket('ws://' + url);
		socket.onopen = (event) => {
			connectionStatusDom.textContent = 'Verbunden';
			initialized = false;
		};
		socket.onclose = (event) => { connectionStatusDom.textContent = 'Nicht verbunden'; };
		socket.onmessage = (event) => {
			console.log(event.data);
			if(!initialized){
				stepsNState = readGame(event.data);
				restart(stepsNState);
				connectionStatusDom.textContent = 'Bereit';
				initialized = true;
			} else {
				let step = readStep(event.data);
				steps.push(step);
				reloadNbSteps();
				if(steps.length == 1) nxt();
			}
		}
		socket.onerror = (err) => { console.error(err); }
	}

	const urlParams = new URLSearchParams(window.location.search);
	const liveurl = urlParams.get('liveurl');
	if(liveurl){
		document.getElementById('server-to-connect').value = liveurl;
		connectToServer();
	}
</script>
</html>
